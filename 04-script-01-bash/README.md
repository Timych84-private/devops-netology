# Домашнее задание к занятию "4.1. Командная оболочка Bash: Практические навыки"

## Обязательные задания

1. Есть скрипт:
	```bash
	a=1
	b=2
	c=a+b
	d=$a+$b
	e=$(($a+$b))
	```
	* Какие значения переменным c,d,e будут присвоены?
	* Почему?
    
    - $c равно a+b - результат c=a+b просто строка
    - $d равно 1+2 - результат строка и подставленные символы 1 и 2 из переменных a и b
    - $e равно 3 - результат сложения a и b как целых чисел из-за применения (())


2. На нашем локальном сервере упал сервис и мы написали скрипт, который постоянно проверяет его доступность, записывая дату проверок до тех пор, пока сервис не станет доступным. В скрипте допущена ошибка, из-за которой выполнение не может завершиться, при этом место на Жёстком Диске постоянно уменьшается. Что необходимо сделать, чтобы его исправить:
	```bash
	while ((1==1)
	do
	curl https://localhost:4757
	if (($? != 0))
	then
	date >> curl.log
	fi
	done
	```
    Исправленный и дополненный скрипт для проверки разных адресов в виде параметра и записи даты и ошибок в файл:

    ```bash
    ARG1=${1:-'http://localhost:4757'}
    while ((1==1))
    do
        clear
        echo "$( date +%Y-%m-%d-%H:%M:%S ) waiting for request from $ARG1"
        result=$( curl -sSk $ARG1 2>&1 )
        if (($? != 0))
        then
            echo "$( date +%Y-%m-%d-%H:%M:%S ) - $result" >> curl.log
        else
            echo $result
            break
        fi
        sleep 1
    done
    ```
1. Необходимо написать скрипт, который проверяет доступность трёх IP: 192.168.0.1, 173.194.222.113, 87.250.250.242 по 80 порту и записывает результат в файл log. Проверять доступность необходимо пять раз для каждого узла.

    создаем файл iplist.txt со списком адресов(для теста добавим "неправильный" ip-адрес):
    ```bash
    cat iplist.txt
        192.168.0.1
        173.194.222.113
        87.250.250.242
        125.956.55.11
    ```
    Скрипт проверяет айпи из файла iplist.txt, проверяет корректность ip-адреса, проверяет 80 порт, успешные попытки отправляет в success.log, неуспешные в error.log:

    ```bash
    while read ip; do
    if [[ $ip =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?) ]]
    then
    i=1
        while ((i<=5))
        do
        echo "checking $ip port 80 attempt $i"
        result=$( curl -sSk $ip 2>&1 )
        if  (($? == 0))
        then
            echo "$ip attempt $i success"
            echo "$( date +%Y-%m-%d-%H:%M:%S ); $ip; $i; $result" >> success.log
        else
            echo "$ip attempt $i failed"
            echo "$( date +%Y-%m-%d-%H:%M:%S ); $ip; $i; $result" >> error.log
        fi
        ((i+=1))
        sleep 1
        done
    else
        echo "$ip wrong format"
    fi
    done <iplist.txt
    ```

1. Необходимо дописать скрипт из предыдущего задания так, чтобы он выполнялся до тех пор, пока один из узлов не окажется недоступным. Если любой из узлов недоступен - IP этого узла пишется в файл error, скрипт прерывается

    Измененный скрипт, в каждой попытке проверяются все ip из файла, в случае ошибки проверки - выход из обоих циклов и запись ошибки в error.log:
    ```bash
    i=1
    while ((1==1))
    do
    while read ip; do
        if [[ $ip =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?) ]]
        then
        echo "checking $ip port 80 attempt $i"
        result=$( curl -sSk --max-time 1 $ip 2>&1 )
        if  (($? == 0))
        then
            echo "$ip attempt $i success"
            echo "$( date +%Y-%m-%d-%H:%M:%S ); $ip; $i; $result" >> success.log
        else
            echo "$ip attempt $i failed"
            echo "$( date +%Y-%m-%d-%H:%M:%S ); $ip; $i; $result" >> error.log
            break 2
        fi
        sleep 1
        else
        echo "$ip wrong format"
        fi
    done < iplist.txt
    ((i+=1))
    done
    ```





## Дополнительное задание (со звездочкой*) - необязательно к выполнению

Мы хотим, чтобы у нас были красивые сообщения для коммитов в репозиторий. Для этого нужно написать локальный хук для git, который будет проверять, что сообщение в коммите содержит код текущего задания в квадратных скобках и количество символов в сообщении не превышает 30. Пример сообщения: \[04-script-01-bash\] сломал хук.



```bash
#!/usr/bin/env bash
commit_regex="^.*\[04-script-01-bash\].*"
text_msg=$(cat $1)
if  ( grep -qE "$commit_regex" "$1" ) && [ "${#text_msg}" -le 30  ]
then
        exit 0
else
        echo   Wrong Commit Message: $text_msg Length:${#text_msg} 
        exit 1
fi
```

